<h1>Tax Table</h1>

<%= render "debug" %>

<div  id='tax_table_div' >
<table class='standard_table'>


<% projects = [] %>
<% column_totals = {} %>
<% if @taxonomy_by_site_hash.any? %>
	<tr><th style='text-align:right;'>Projects:</th>
<!--
## Getting data out of these nested hashes is way too difficult
## especially if we have to sort the data 
-->
	<% @taxonomy_by_site_hash.each do |tax, data| %>
	  <% data.each do |project, ds_hash|%>
		<% ds_hash.each do |dataset|%>
			<% ds = dataset[0] %>
			<% count = dataset[1] %>
			<% pd = project+'--'+ds %>
			<% if not projects.include?(pd) then %>
				<% projects << pd %>
			<% end %>
		<% end %>
	  <% end %>
	<% end %>

	<% @ordered_datasets.each do |p| %>
		
	  		<td style='text-align:center;' colspan='<%= p[:datasets].length %>'> <%= p[:pname] %> </td>   
	  	
	<% end %>
	</tr>
	<tr><th style='text-align:left;'>Taxonomy:</th>
	<% @ordered_datasets.each do |p| %>
		<% p[:datasets].each do |d| %>
		  <td style='padding:0 2px 0 2px;'> <%= d[:dname] %> </td> 
		<% end %>
	<% end %>

    
    </tr>

	<% @taxonomy_by_site_hash.each do |tax, data| %>
	<tr><td nowrap='nowrap'><%= tax %></td>
	
	  <% data.each do |project, ds_hash|%>
		<% ds_hash.each do |dataset|%>
			<% ds = dataset[0] %>
			<% count = dataset[1] %>
			<% pd = project+'--'+ds %>
			<td><%= count %></td>
			<% if column_totals.has_key?(pd) then %>
			  <% column_totals[pd] += count %>
			<% else %>
			  <% column_totals[pd] = count %>
			<% end %>
		<% end %>
	  <% end %>
	  </tr>
	<% end %>

<% else %>
	<tr><td><strong>NO DATA</strong></td></tr>
<% end %>
<tr>
	<td><b>TOTALS:</b></td>
	<% column_totals.each do |t| %>
  		<td><b><%= number_with_delimiter(t[1]) %></b></td>
	<% end %>
</td>
</table>
</div>

